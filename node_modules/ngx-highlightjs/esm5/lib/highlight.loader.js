import { __decorate, __metadata, __param, __read, __spread } from "tslib";
import { Injectable, Inject, PLATFORM_ID, Optional } from '@angular/core';
import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { BehaviorSubject, from, EMPTY, zip } from 'rxjs';
import { catchError, tap, map, switchMap, filter, take } from 'rxjs/operators';
import { HIGHLIGHT_OPTIONS } from './highlight.model';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "./highlight.model";
// @dynamic
var HighlightLoader = /** @class */ (function () {
    function HighlightLoader(doc, platformId, _options) {
        var _this = this;
        this._options = _options;
        // Stream that emits when hljs library is loaded and ready to use
        this._ready = new BehaviorSubject(null);
        this.ready = this._ready.asObservable().pipe(filter(function (hljs) { return !!hljs; }), take(1));
        // Check if hljs is already available
        if (isPlatformBrowser(platformId) && doc.defaultView.hljs) {
            this._ready.next(doc.defaultView.hljs);
        }
        else {
            // Load hljs library
            this._loadLibrary().pipe(switchMap(function (hljs) {
                if (_this._options && _this._options.lineNumbers) {
                    // Make hljs available on window object (required for the line numbers library)
                    doc.defaultView.hljs = hljs;
                    // Load line numbers library
                    return loadLineNumbers().pipe(tap(function () { return _this._ready.next(hljs); }));
                }
                else {
                    _this._ready.next(hljs);
                    return EMPTY;
                }
            }), catchError(function (e) {
                console.error('Unable to load hljs library', e);
                return EMPTY;
            })).subscribe();
        }
    }
    /**
     * Lazy-Load highlight.js library
     */
    HighlightLoader.prototype._loadLibrary = function () {
        var _this = this;
        return (this._options && this._options.languages && Object.keys(this._options.languages).length)
            ? from(loadCoreLibrary()).pipe(switchMap(function (hljs) { return _this._loadLanguages(hljs); }))
            : from(loadAllLibrary());
    };
    /**
     * Lazy-load highlight.js languages
     */
    HighlightLoader.prototype._loadLanguages = function (hljs) {
        var languages = Object.entries(this._options.languages).map(function (_a) {
            var _b = __read(_a, 2), langName = _b[0], langLoader = _b[1];
            return importModule(langLoader()).pipe(tap(function (langFunc) { return hljs.registerLanguage(langName, langFunc); }));
        });
        return zip.apply(void 0, __spread(languages)).pipe(map(function () { return hljs; }));
    };
    HighlightLoader.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
        { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
        { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [HIGHLIGHT_OPTIONS,] }] }
    ]; };
    HighlightLoader.ɵprov = i0.ɵɵdefineInjectable({ factory: function HighlightLoader_Factory() { return new HighlightLoader(i0.ɵɵinject(i1.DOCUMENT), i0.ɵɵinject(i0.PLATFORM_ID), i0.ɵɵinject(i2.HIGHLIGHT_OPTIONS, 8)); }, token: HighlightLoader, providedIn: "root" });
    HighlightLoader = __decorate([
        Injectable({
            providedIn: 'root'
        }),
        __param(0, Inject(DOCUMENT)),
        __param(1, Inject(PLATFORM_ID)),
        __param(2, Optional()), __param(2, Inject(HIGHLIGHT_OPTIONS)),
        __metadata("design:paramtypes", [Object, Object, Object])
    ], HighlightLoader);
    return HighlightLoader;
}());
export { HighlightLoader };
/**
 * Import highlight.js core library
 */
function loadCoreLibrary() {
    return importModule(import('highlight.js/lib/highlight'));
}
/**
 * Import highlight.js library with all languages
 */
function loadAllLibrary() {
    return importModule(import('highlight.js'));
}
/**
 * Import line numbers library
 */
function loadLineNumbers() {
    return importModule(import('highlightjs-line-numbers.js'));
}
/**
 * Map loader response to module object
 */
var importModule = function (moduleLoader) {
    return from(moduleLoader).pipe(filter(function (module) { return !!module && !!module.default; }), map(function (module) { return module.default; }));
};
var ɵ0 = importModule;
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0LmxvYWRlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1oaWdobGlnaHRqcy8iLCJzb3VyY2VzIjpbImxpYi9oaWdobGlnaHQubG9hZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsZUFBZSxFQUFjLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQy9FLE9BQU8sRUFBRSxpQkFBaUIsRUFBc0MsTUFBTSxtQkFBbUIsQ0FBQzs7OztBQUUxRixXQUFXO0FBSVg7SUFRRSx5QkFBOEIsR0FBUSxFQUNMLFVBQWtCLEVBQ1EsUUFBMEI7UUFGckYsaUJBMEJDO1FBeEIwRCxhQUFRLEdBQVIsUUFBUSxDQUFrQjtRQVRyRixpRUFBaUU7UUFDaEQsV0FBTSxHQUFHLElBQUksZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzNDLFVBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDLElBQUksQ0FDOUMsTUFBTSxDQUFDLFVBQUMsSUFBc0IsSUFBSyxPQUFBLENBQUMsQ0FBQyxJQUFJLEVBQU4sQ0FBTSxDQUFDLEVBQzFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FDUixDQUFDO1FBS0EscUNBQXFDO1FBQ3JDLElBQUksaUJBQWlCLENBQUMsVUFBVSxDQUFDLElBQUksR0FBRyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUU7WUFDekQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJ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RztBQUNILFNBQVMsZUFBZTtJQUN0QixPQUFPLFlBQVksQ0FBQyxNQUFNLENBQUMsNEJBQTRCLENBQUMsQ0FBQyxDQUFDO0FBQzVELENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsY0FBYztJQUNyQixPQUFPLFlBQVksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztBQUM5QyxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLGVBQWU7SUFDdEIsT0FBTyxZQUFZLENBQUMsTUFBTSxDQUFDLDZCQUE2QixDQUFDLENBQUMsQ0FBQztBQUM3RCxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxJQUFNLFlBQVksR0FBRyxVQUFDLFlBQTBCO0lBQzlDLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FDNUIsTUFBTSxDQUFDLFVBQUMsTUFBVyxJQUFLLE9BQUEsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBNUIsQ0FBNEIsQ0FBQyxFQUNyRCxHQUFHLENBQUMsVUFBQyxNQUFXLElBQUssT0FBQSxNQUFNLENBQUMsT0FBTyxFQUFkLENBQWMsQ0FBQyxDQUNyQyxDQUFDO0FBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0LCBQTEFURk9STV9JRCwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERPQ1VNRU5ULCBpc1BsYXRmb3JtQnJvd3NlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUsIGZyb20sIEVNUFRZLCB6aXAgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIHRhcCwgbWFwLCBzd2l0Y2hNYXAsIGZpbHRlciwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEhJR0hMSUdIVF9PUFRJT05TLCBIaWdobGlnaHRMaWJyYXJ5LCBIaWdobGlnaHRPcHRpb25zIH0gZnJvbSAnLi9oaWdobGlnaHQubW9kZWwnO1xuXG4vLyBAZHluYW1pY1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgSGlnaGxpZ2h0TG9hZGVyIHtcbiAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBobGpzIGxpYnJhcnkgaXMgbG9hZGVkIGFuZCByZWFkeSB0byB1c2VcbiAgcHJpdmF0ZSByZWFkb25seSBfcmVhZHkgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KG51bGwpO1xuICByZWFkb25seSByZWFkeSA9IHRoaXMuX3JlYWR5LmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgZmlsdGVyKChobGpzOiBIaWdobGlnaHRMaWJyYXJ5KSA9PiAhIWhsanMpLFxuICAgIHRha2UoMSlcbiAgKTtcblxuICBjb25zdHJ1Y3RvcihASW5qZWN0KERPQ1VNRU5UKSBkb2M6IGFueSxcbiAgICAgICAgICAgICAgQEluamVjdChQTEFURk9STV9JRCkgcGxhdGZvcm1JZDogb2JqZWN0LFxuICAgICAgICAgICAgICBAT3B0aW9uYWwoKSBASW5qZWN0KEhJR0hMSUdIVF9PUFRJT05TKSBwcml2YXRlIF9vcHRpb25zOiBIaWdobGlnaHRPcHRpb25zKSB7XG4gICAgLy8gQ2hlY2sgaWYgaGxqcyBpcyBhbHJlYWR5IGF2YWlsYWJsZVxuICAgIGlmIChpc1BsYXRmb3JtQnJvd3NlcihwbGF0Zm9ybUlkKSAmJiBkb2MuZGVmYXVsdFZpZXcuaGxqcykge1xuICAgICAgdGhpcy5fcmVhZHkubmV4dChkb2MuZGVmYXVsdFZpZXcuaGxqcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIExvYWQgaGxqcyBsaWJyYXJ5XG4gICAgICB0aGlzLl9sb2FkTGlicmFyeSgpLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgoaGxqczogSGlnaGxpZ2h0TGlicmFyeSkgPT4ge1xuICAgICAgICAgIGlmICh0aGlzLl9vcHRpb25zICYmIHRoaXMuX29wdGlvbnMubGluZU51bWJlcnMpIHtcbiAgICAgICAgICAgIC8vIE1ha2UgaGxqcyBhdmFpbGFibGUgb24gd2luZG93IG9iamVjdCAocmVxdWlyZWQgZm9yIHRoZSBsaW5lIG51bWJlcnMgbGlicmFyeSlcbiAgICAgICAgICAgIGRvYy5kZWZhdWx0Vmlldy5obGpzID0gaGxqcztcbiAgICAgICAgICAgIC8vIExvYWQgbGluZSBudW1iZXJzIGxpYnJhcnlcbiAgICAgICAgICAgIHJldHVybiBsb2FkTGluZU51bWJlcnMoKS5waXBlKHRhcCgoKSA9PiB0aGlzLl9yZWFkeS5uZXh0KGhsanMpKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3JlYWR5Lm5leHQoaGxqcyk7XG4gICAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgICAgY2F0Y2hFcnJvcigoZTogYW55KSA9PiB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignVW5hYmxlIHRvIGxvYWQgaGxqcyBsaWJyYXJ5JywgZSk7XG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xuICAgICAgICB9KVxuICAgICAgKS5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTGF6eS1Mb2FkIGhpZ2hsaWdodC5qcyBsaWJyYXJ5XG4gICAqL1xuICBwcml2YXRlIF9sb2FkTGlicmFyeSgpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiAodGhpcy5fb3B0aW9ucyAmJiB0aGlzLl9vcHRpb25zLmxhbmd1YWdlcyAmJiBPYmplY3Qua2V5cyh0aGlzLl9vcHRpb25zLmxhbmd1YWdlcykubGVuZ3RoKVxuICAgICAgPyBmcm9tKGxvYWRDb3JlTGlicmFyeSgpKS5waXBlKHN3aXRjaE1hcCgoaGxqczogSGlnaGxpZ2h0TGlicmFyeSkgPT4gdGhpcy5fbG9hZExhbmd1YWdlcyhobGpzKSkpXG4gICAgICA6IGZyb20obG9hZEFsbExpYnJhcnkoKSk7XG4gIH1cblxuICAvKipcbiAgICogTGF6eS1sb2FkIGhpZ2hsaWdodC5qcyBsYW5ndWFnZXNcbiAgICovXG4gIHByaXZhdGUgX2xvYWRMYW5ndWFnZXMoaGxqczogSGlnaGxpZ2h0TGlicmFyeSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgbGFuZ3VhZ2VzID0gT2JqZWN0LmVudHJpZXModGhpcy5fb3B0aW9ucy5sYW5ndWFnZXMpLm1hcCgoW2xhbmdOYW1lLCBsYW5nTG9hZGVyXSkgPT5cbiAgICAgIGltcG9ydE1vZHVsZShsYW5nTG9hZGVyKCkpLnBpcGUoXG4gICAgICAgIHRhcCgobGFuZ0Z1bmM6IGFueSkgPT4gaGxqcy5yZWdpc3Rlckxhbmd1YWdlKGxhbmdOYW1lLCBsYW5nRnVuYykpXG4gICAgICApXG4gICAgKTtcbiAgICByZXR1cm4gemlwKC4uLmxhbmd1YWdlcykucGlwZShtYXAoKCkgPT4gaGxqcykpO1xuICB9XG59XG5cbi8qKlxuICogSW1wb3J0IGhpZ2hsaWdodC5qcyBjb3JlIGxpYnJhcnlcbiAqL1xuZnVuY3Rpb24gbG9hZENvcmVMaWJyYXJ5KCk6IE9ic2VydmFibGU8SGlnaGxpZ2h0TGlicmFyeT4ge1xuICByZXR1cm4gaW1wb3J0TW9kdWxlKGltcG9ydCgnaGlnaGxpZ2h0LmpzL2xpYi9oaWdobGlnaHQnKSk7XG59XG5cbi8qKlxuICogSW1wb3J0IGhpZ2hsaWdodC5qcyBsaWJyYXJ5IHdpdGggYWxsIGxhbmd1YWdlc1xuICovXG5mdW5jdGlvbiBsb2FkQWxsTGlicmFyeSgpOiBPYnNlcnZhYmxlPEhpZ2hsaWdodExpYnJhcnk+IHtcbiAgcmV0dXJuIGltcG9ydE1vZHVsZShpbXBvcnQoJ2hpZ2hsaWdodC5qcycpKTtcbn1cblxuLyoqXG4gKiBJbXBvcnQgbGluZSBudW1iZXJzIGxpYnJhcnlcbiAqL1xuZnVuY3Rpb24gbG9hZExpbmVOdW1iZXJzKCk6IE9ic2VydmFibGU8YW55PiB7XG4gIHJldHVybiBpbXBvcnRNb2R1bGUoaW1wb3J0KCdoaWdobGlnaHRqcy1saW5lLW51bWJlcnMuanMnKSk7XG59XG5cbi8qKlxuICogTWFwIGxvYWRlciByZXNwb25zZSB0byBtb2R1bGUgb2JqZWN0XG4gKi9cbmNvbnN0IGltcG9ydE1vZHVsZSA9IChtb2R1bGVMb2FkZXI6IFByb21pc2U8YW55Pik6IE9ic2VydmFibGU8YW55PiA9PiB7XG4gIHJldHVybiBmcm9tKG1vZHVsZUxvYWRlcikucGlwZShcbiAgICBmaWx0ZXIoKG1vZHVsZTogYW55KSA9PiAhIW1vZHVsZSAmJiAhIW1vZHVsZS5kZWZhdWx0KSxcbiAgICBtYXAoKG1vZHVsZTogYW55KSA9PiBtb2R1bGUuZGVmYXVsdClcbiAgKTtcbn07XG4iXX0=