import { __decorate, __metadata, __param } from "tslib";
import { Directive, Input, Output, Inject, Optional, OnChanges, SimpleChanges, EventEmitter, ElementRef, SecurityContext } from '@angular/core';
import { DomSanitizer } from '@angular/platform-browser';
import { animationFrameScheduler } from 'rxjs';
import { HighlightJS } from './highlight.service';
import { HIGHLIGHT_OPTIONS } from './highlight.model';
var Highlight = /** @class */ (function () {
    function Highlight(el, _hljs, _sanitizer, _options) {
        this._hljs = _hljs;
        this._sanitizer = _sanitizer;
        this._options = _options;
        // Stream that emits when code string is highlighted
        this.highlighted = new EventEmitter();
        this._nativeElement = el.nativeElement;
    }
    Highlight.prototype.ngOnChanges = function (changes) {
        if (changes.code &&
            changes.code.currentValue &&
            changes.code.currentValue !== changes.code.previousValue) {
            this.highlightElement(this.code, this.languages);
        }
    };
    /**
     * Highlighting with language detection and fix markup.
     * @param code Accepts a string with the code to highlight
     * @param languages An optional array of language names and aliases restricting detection to only those languages.
     * The subset can also be set with configure, but the local parameter overrides the option if set.
     */
    Highlight.prototype.highlightElement = function (code, languages) {
        var _this = this;
        // Set code text before highlighting
        this.setTextContent(code);
        this._hljs.highlightAuto(code, languages).subscribe(function (res) {
            // Set highlighted code
            _this.setInnerHTML(res.value);
            // Check if user want to show line numbers
            if (_this.lineNumbers && _this._options && _this._options.lineNumbers) {
                _this.addLineNumbers();
            }
            // Forward highlight response to the highlighted output
            _this.highlighted.emit(res);
        });
    };
    Highlight.prototype.addLineNumbers = function () {
        var _this = this;
        // Clean up line numbers observer
        this.destroyLineNumbersObserver();
        animationFrameScheduler.schedule(function () {
            // Add line numbers
            _this._hljs.lineNumbersBlock(_this._nativeElement).subscribe();
            // If lines count is 1, the line numbers library will not add numbers
            // Observe changes to add 'hljs-line-numbers' class only when line numbers is added to the code element
            _this._lineNumbersObs = new MutationObserver(function () {
                if (_this._nativeElement.firstElementChild && _this._nativeElement.firstElementChild.tagName.toUpperCase() === 'TABLE') {
                    _this._nativeElement.classList.add('hljs-line-numbers');
                }
                _this.destroyLineNumbersObserver();
            });
            _this._lineNumbersObs.observe(_this._nativeElement, { childList: true });
        });
    };
    Highlight.prototype.destroyLineNumbersObserver = function () {
        if (this._lineNumbersObs) {
            this._lineNumbersObs.disconnect();
            this._lineNumbersObs = null;
        }
    };
    Highlight.prototype.setTextContent = function (content) {
        var _this = this;
        animationFrameScheduler.schedule(function () {
            return _this._nativeElement.textContent = content;
        });
    };
    Highlight.prototype.setInnerHTML = function (content) {
        var _this = this;
        animationFrameScheduler.schedule(function () {
            return _this._nativeElement.innerHTML = _this._sanitizer.sanitize(SecurityContext.HTML, content);
        });
    };
    Highlight.ctorParameters = function () { return [
        { type: ElementRef },
        { type: HighlightJS },
        { type: DomSanitizer },
        { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [HIGHLIGHT_OPTIONS,] }] }
    ]; };
    __decorate([
        Input('highlight'),
        __metadata("design:type", String)
    ], Highlight.prototype, "code", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Array)
    ], Highlight.prototype, "languages", void 0);
    __decorate([
        Input(),
        __metadata("design:type", Boolean)
    ], Highlight.prototype, "lineNumbers", void 0);
    __decorate([
        Output(),
        __metadata("design:type", Object)
    ], Highlight.prototype, "highlighted", void 0);
    Highlight = __decorate([
        Directive({
            host: {
                '[class.hljs]': 'true'
            },
            selector: '[highlight]'
        }),
        __param(3, Optional()), __param(3, Inject(HIGHLIGHT_OPTIONS)),
        __metadata("design:paramtypes", [ElementRef,
            HighlightJS,
            DomSanitizer, Object])
    ], Highlight);
    return Highlight;
}());
export { Highlight };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LWhpZ2hsaWdodGpzLyIsInNvdXJjZXMiOlsibGliL2hpZ2hsaWdodC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsTUFBTSxFQUNOLE1BQU0sRUFDTixRQUFRLEVBQ1IsU0FBUyxFQUNULGFBQWEsRUFDYixZQUFZLEVBQ1osVUFBVSxFQUNWLGVBQWUsRUFDaEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3pELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbEQsT0FBTyxFQUFFLGlCQUFpQixFQUFxQyxNQUFNLG1CQUFtQixDQUFDO0FBUXpGO0lBcUJFLG1CQUFZLEVBQWMsRUFDTixLQUFrQixFQUNsQixVQUF3QixFQUNlLFFBQTBCO1FBRmpFLFVBQUssR0FBTCxLQUFLLENBQWE7UUFDbEIsZUFBVSxHQUFWLFVBQVUsQ0FBYztRQUNlLGFBQVEsR0FBUixRQUFRLENBQWtCO1FBTnJGLG9EQUFvRDtRQUMxQyxnQkFBVyxHQUFHLElBQUksWUFBWSxFQUFtQixDQUFDO1FBTTFELElBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDLGFBQWEsQ0FBQztJQUN6QyxDQUFDO0lBRUQsK0JBQVcsR0FBWCxVQUFZLE9BQXNCO1FBQ2hDLElBQ0UsT0FBTyxDQUFDLElBQUk7WUFDWixPQUFPLENBQUMsSUFBSSxDQUFDLFlBQVk7WUFDekIsT0FBTyxDQUFDLElBQUksQ0FBQyxZQUFZLEtBQUssT0FBTyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQ3hEO1lBQ0EsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NB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a0RBQW1EO0lBbkJqRCxTQUFTO1FBTnJCLFNBQVMsQ0FBQztZQUNULElBQUksRUFBRTtnQkFDSixjQUFjLEVBQUUsTUFBTTthQUN2QjtZQUNELFFBQVEsRUFBRSxhQUFhO1NBQ3hCLENBQUM7UUF5QmEsV0FBQSxRQUFRLEVBQUUsQ0FBQSxFQUFFLFdBQUEsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUE7eUNBSGxDLFVBQVU7WUFDQyxXQUFXO1lBQ04sWUFBWTtPQXZCakMsU0FBUyxDQStGckI7SUFBRCxnQkFBQztDQUFBLEFBL0ZELElBK0ZDO1NBL0ZZLFNBQVMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBEaXJlY3RpdmUsXG4gIElucHV0LFxuICBPdXRwdXQsXG4gIEluamVjdCxcbiAgT3B0aW9uYWwsXG4gIE9uQ2hhbmdlcyxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgRXZlbnRFbWl0dGVyLFxuICBFbGVtZW50UmVmLFxuICBTZWN1cml0eUNvbnRleHRcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBEb21TYW5pdGl6ZXIgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcbmltcG9ydCB7IGFuaW1hdGlvbkZyYW1lU2NoZWR1bGVyIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBIaWdobGlnaHRKUyB9IGZyb20gJy4vaGlnaGxpZ2h0LnNlcnZpY2UnO1xuaW1wb3J0IHsgSElHSExJR0hUX09QVElPTlMsIEhpZ2hsaWdodE9wdGlvbnMsIEhpZ2hsaWdodFJlc3VsdCB9IGZyb20gJy4vaGlnaGxpZ2h0Lm1vZGVsJztcblxuQERpcmVjdGl2ZSh7XG4gIGhvc3Q6IHtcbiAgICAnW2NsYXNzLmhsanNdJzogJ3RydWUnXG4gIH0sXG4gIHNlbGVjdG9yOiAnW2hpZ2hsaWdodF0nXG59KVxuZXhwb3J0IGNsYXNzIEhpZ2hsaWdodCBpbXBsZW1lbnRzIE9uQ2hhbmdlcyB7XG5cbiAgLy8gSGlnaGxpZ2h0ZWQgQ29kZVxuICBwcml2YXRlIHJlYWRvbmx5IF9uYXRpdmVFbGVtZW50OiBIVE1MRWxlbWVudDtcblxuICAvLyBUZW1wIG9ic2VydmVyIHRvIG9ic2VydmUgd2hlbiBsaW5lIG51bWJlcnMgaGFzIGJlZW4gYWRkZWQgdG8gY29kZSBlbGVtZW50XG4gIHByaXZhdGUgX2xpbmVOdW1iZXJzT2JzOiBhbnk7XG5cbiAgLy8gSGlnaGxpZ2h0IGNvZGUgaW5wdXRcbiAgQElucHV0KCdoaWdobGlnaHQnKSBjb2RlITogc3RyaW5nO1xuXG4gIC8vIEFuIG9wdGlvbmFsIGFycmF5IG9mIGxhbmd1YWdlIG5hbWVzIGFuZCBhbGlhc2VzIHJlc3RyaWN0aW5nIGRldGVjdGlvbiB0byBvbmx5IHRob3NlIGxhbmd1YWdlcy5cbiAgLy8gVGhlIHN1YnNldCBjYW4gYWxzbyBiZSBzZXQgd2l0aCBjb25maWd1cmUsIGJ1dCB0aGUgbG9jYWwgcGFyYW1ldGVyIG92ZXJyaWRlcyB0aGUgb3B0aW9uIGlmIHNldC5cbiAgQElucHV0KCkgbGFuZ3VhZ2VzITogc3RyaW5nW107XG5cbiAgLy8gU2hvdyBsaW5lIG51bWJlcnNcbiAgQElucHV0KCkgbGluZU51bWJlcnMhOiBib29sZWFuO1xuXG4gIC8vIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gY29kZSBzdHJpbmcgaXMgaGlnaGxpZ2h0ZWRcbiAgQE91dHB1dCgpIGhpZ2hsaWdodGVkID0gbmV3IEV2ZW50RW1pdHRlcjxIaWdobGlnaHRSZXN1bHQ+KCk7XG5cbiAgY29uc3RydWN0b3IoZWw6IEVsZW1lbnRSZWYsXG4gICAgICAgICAgICAgIHByaXZhdGUgX2hsanM6IEhpZ2hsaWdodEpTLFxuICAgICAgICAgICAgICBwcml2YXRlIF9zYW5pdGl6ZXI6IERvbVNhbml0aXplcixcbiAgICAgICAgICAgICAgQE9wdGlvbmFsKCkgQEluamVjdChISUdITElHSFRfT1BUSU9OUykgcHJpdmF0ZSBfb3B0aW9uczogSGlnaGxpZ2h0T3B0aW9ucykge1xuICAgIHRoaXMuX25hdGl2ZUVsZW1lbnQgPSBlbC5uYXRpdmVFbGVtZW50O1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGlmIChcbiAgICAgIGNoYW5nZXMuY29kZSAmJlxuICAgICAgY2hhbmdlcy5jb2RlLmN1cnJlbnRWYWx1ZSAmJlxuICAgICAgY2hhbmdlcy5jb2RlLmN1cnJlbnRWYWx1ZSAhPT0gY2hhbmdlcy5jb2RlLnByZXZpb3VzVmFsdWVcbiAgICApIHtcbiAgICAgIHRoaXMuaGlnaGxpZ2h0RWxlbWVudCh0aGlzLmNvZGUsIHRoaXMubGFuZ3VhZ2VzKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSGlnaGxpZ2h0aW5nIHdpdGggbGFuZ3VhZ2UgZGV0ZWN0aW9uIGFuZCBmaXggbWFya3VwLlxuICAgKiBAcGFyYW0gY29kZSBBY2NlcHRzIGEgc3RyaW5nIHdpdGggdGhlIGNvZGUgdG8gaGlnaGxpZ2h0XG4gICAqIEBwYXJhbSBsYW5ndWFnZXMgQW4gb3B0aW9uYWwgYXJyYXkgb2YgbGFuZ3VhZ2UgbmFtZXMgYW5kIGFsaWFzZXMgcmVzdHJpY3RpbmcgZGV0ZWN0aW9uIHRvIG9ubHkgdGhvc2UgbGFuZ3VhZ2VzLlxuICAgKiBUaGUgc3Vic2V0IGNhbiBhbHNvIGJlIHNldCB3aXRoIGNvbmZpZ3VyZSwgYnV0IHRoZSBsb2NhbCBwYXJhbWV0ZXIgb3ZlcnJpZGVzIHRoZSBvcHRpb24gaWYgc2V0LlxuICAgKi9cbiAgaGlnaGxpZ2h0RWxlbWVudChjb2RlOiBzdHJpbmcsIGxhbmd1YWdlcz86IHN0cmluZ1tdKTogdm9pZCB7XG4gICAgLy8gU2V0IGNvZGUgdGV4dCBiZWZvcmUgaGlnaGxpZ2h0aW5nXG4gICAgdGhpcy5zZXRUZXh0Q29udGVudChjb2RlKTtcbiAgICB0aGlzLl9obGpzLmhpZ2hsaWdodEF1dG8oY29kZSwgbGFuZ3VhZ2VzKS5zdWJzY3JpYmUoKHJlczogYW55KSA9PiB7XG4gICAgICAvLyBTZXQgaGlnaGxpZ2h0ZWQgY29kZVxuICAgICAgdGhpcy5zZXRJbm5lckhUTUwocmVzLnZhbHVlKTtcbiAgICAgIC8vIENoZWNrIGlmIHVzZXIgd2FudCB0byBzaG93IGxpbmUgbnVtYmVyc1xuICAgICAgaWYgKHRoaXMubGluZU51bWJlcnMgJiYgdGhpcy5fb3B0aW9ucyAmJiB0aGlzLl9vcHRpb25zLmxpbmVOdW1iZXJzKSB7XG4gICAgICAgIHRoaXMuYWRkTGluZU51bWJlcnMoKTtcbiAgICAgIH1cbiAgICAgIC8vIEZvcndhcmQgaGlnaGxpZ2h0IHJlc3BvbnNlIHRvIHRoZSBoaWdobGlnaHRlZCBvdXRwdXRcbiAgICAgIHRoaXMuaGlnaGxpZ2h0ZWQuZW1pdChyZXMpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRMaW5lTnVtYmVycygpIHtcbiAgICAvLyBDbGVhbiB1cCBsaW5lIG51bWJlcnMgb2JzZXJ2ZXJcbiAgICB0aGlzLmRlc3Ryb3lMaW5lTnVtYmVyc09ic2VydmVyKCk7XG4gICAgYW5pbWF0aW9uRnJhbWVTY2hlZHVsZXIuc2NoZWR1bGUoKCkgPT4ge1xuICAgICAgLy8gQWRkIGxpbmUgbnVtYmVyc1xuICAgICAgdGhpcy5faGxqcy5saW5lTnVtYmVyc0Jsb2NrKHRoaXMuX25hdGl2ZUVsZW1lbnQpLnN1YnNjcmliZSgpO1xuICAgICAgLy8gSWYgbGluZXMgY291bnQgaXMgMSwgdGhlIGxpbmUgbnVtYmVycyBsaWJyYXJ5IHdpbGwgbm90IGFkZCBudW1iZXJzXG4gICAgICAvLyBPYnNlcnZlIGNoYW5nZXMgdG8gYWRkICdobGpzLWxpbmUtbnVtYmVycycgY2xhc3Mgb25seSB3aGVuIGxpbmUgbnVtYmVycyBpcyBhZGRlZCB0byB0aGUgY29kZSBlbGVtZW50XG4gICAgICB0aGlzLl9saW5lTnVtYmVyc09icyA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKCgpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuX25hdGl2ZUVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQgJiYgdGhpcy5fbmF0aXZlRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZC50YWdOYW1lLnRvVXBwZXJDYXNlKCkgPT09ICdUQUJMRScpIHtcbiAgICAgICAgICB0aGlzLl9uYXRpdmVFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ2hsanMtbGluZS1udW1iZXJzJyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kZXN0cm95TGluZU51bWJlcnNPYnNlcnZlcigpO1xuICAgICAgfSk7XG4gICAgICB0aGlzLl9saW5lTnVtYmVyc09icy5vYnNlcnZlKHRoaXMuX25hdGl2ZUVsZW1lbnQsIHsgY2hpbGRMaXN0OiB0cnVlIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95TGluZU51bWJlcnNPYnNlcnZlcigpIHtcbiAgICBpZiAodGhpcy5fbGluZU51bWJlcnNPYnMpIHtcbiAgICAgIHRoaXMuX2xpbmVOdW1iZXJzT2JzLmRpc2Nvbm5lY3QoKTtcbiAgICAgIHRoaXMuX2xpbmVOdW1iZXJzT2JzID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldFRleHRDb250ZW50KGNvbnRlbnQ6IHN0cmluZykge1xuICAgIGFuaW1hdGlvbkZyYW1lU2NoZWR1bGVyLnNjaGVkdWxlKCgpID0+XG4gICAgICB0aGlzLl9uYXRpdmVFbGVtZW50LnRleHRDb250ZW50ID0gY29udGVudFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHNldElubmVySFRNTChjb250ZW50OiBzdHJpbmcpIHtcbiAgICBhbmltYXRpb25GcmFtZVNjaGVkdWxlci5zY2hlZHVsZSgoKSA9PlxuICAgICAgdGhpcy5fbmF0aXZlRWxlbWVudC5pbm5lckhUTUwgPSB0aGlzLl9zYW5pdGl6ZXIuc2FuaXRpemUoU2VjdXJpdHlDb250ZXh0LkhUTUwsIGNvbnRlbnQpXG4gICAgKTtcbiAgfVxufVxuXG4iXX0=